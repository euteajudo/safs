<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste M√≠nimo - Campo Respons√°vel T√©cnico</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button { margin: 5px; padding: 10px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        input, select { margin: 5px; padding: 8px; width: 200px; }
        .form-group { margin: 10px 0; }
        label { display: inline-block; width: 150px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste M√≠nimo - Campo Respons√°vel T√©cnico</h1>
        
        <div class="test-section info">
            <h3>‚ÑπÔ∏è Informa√ß√µes do Sistema</h3>
            <p><strong>URL Atual:</strong> <span id="currentUrl"></span></p>
            <p><strong>API Base:</strong> <span id="apiBase"></span></p>
            <p><strong>Status Backend:</strong> <span id="backendStatus">Verificando...</span></p>
            <p><strong>Token:</strong> <span id="tokenStatus">N√£o verificado</span></p>
        </div>

        <div class="test-section">
            <h3>üîê 1. Login</h3>
            <div class="form-group">
                <label>Username:</label>
                <input type="text" id="username" value="teste2">
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="password" value="123456">
            </div>
            <button onclick="testLogin()">Fazer Login</button>
            <div id="loginResult"></div>
        </div>

        <div class="test-section">
            <h3>üë• 2. Buscar Usu√°rios</h3>
            <button onclick="fetchUsers()" id="fetchUsersBtn" disabled>Buscar Usu√°rios</button>
            <div id="usersResult"></div>
        </div>

        <div class="test-section">
            <h3>üìù 3. Teste Cria√ß√£o - SEM Respons√°vel T√©cnico</h3>
            <div class="form-group">
                <label>C√≥digo Master:</label>
                <input type="text" id="codigoMaster1" value="">
            </div>
            <button onclick="testCreateWithoutResponsavel()" id="createWithoutBtn" disabled>Criar Item SEM Respons√°vel</button>
            <div id="createWithoutResult"></div>
        </div>

        <div class="test-section">
            <h3>üìù 4. Teste Cria√ß√£o - COM Respons√°vel T√©cnico</h3>
            <div class="form-group">
                <label>C√≥digo Master:</label>
                <input type="text" id="codigoMaster2" value="">
            </div>
            <div class="form-group">
                <label>Respons√°vel:</label>
                <select id="responsavelSelect">
                    <option value="">Selecione um usu√°rio...</option>
                </select>
            </div>
            <button onclick="testCreateWithResponsavel()" id="createWithBtn" disabled>Criar Item COM Respons√°vel</button>
            <div id="createWithResult"></div>
        </div>

        <div class="test-section">
            <h3>üìä 5. Log de Requisi√ß√µes</h3>
            <button onclick="clearLogs()">Limpar Logs</button>
            <pre id="requestLogs"></pre>
        </div>
    </div>

    <script>
        let authToken = null;
        let users = [];
        const API_BASE = 'http://localhost:8000';
        
        // Inicializa√ß√£o
        document.getElementById('currentUrl').textContent = window.location.href;
        document.getElementById('apiBase').textContent = API_BASE;
        document.getElementById('codigoMaster1').value = 'TEST_NO_RESP_' + Math.floor(Math.random() * 10000);
        document.getElementById('codigoMaster2').value = 'TEST_WITH_RESP_' + Math.floor(Math.random() * 10000);
        
        function logRequest(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('requestLogs');
            const logEntry = `[${timestamp}] ${message}${data ? '\n' + JSON.stringify(data, null, 2) : ''}\n\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message, data);
        }
        
        function clearLogs() {
            document.getElementById('requestLogs').textContent = '';
        }
        
        function updateStatus(elementId, message, isSuccess = true) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.color = isSuccess ? 'green' : 'red';
        }
        
        async function checkBackend() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/health`, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    updateStatus('backendStatus', '‚úÖ Online', true);
                    logRequest('‚úÖ Backend conectado', data);
                    return true;
                } else {
                    updateStatus('backendStatus', `‚ùå Erro ${response.status}`, false);
                    logRequest('‚ùå Backend erro', { status: response.status });
                    return false;
                }
            } catch (error) {
                updateStatus('backendStatus', '‚ùå Offline', false);
                logRequest('‚ùå Backend offline', { error: error.message });
                return false;
            }
        }
        
        async function testLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            logRequest('üîê Tentando login...', { username });
            
            try {
                const formData = new FormData();
                formData.append('username', username);
                formData.append('password', password);
                
                const response = await fetch(`${API_BASE}/api/v1/token`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    updateStatus('tokenStatus', '‚úÖ Token obtido', true);
                    logRequest('‚úÖ Login realizado', { 
                        token: data.access_token ? data.access_token.substring(0, 50) + '...' : 'Sem token',
                        user: data.user ? data.user.nome : 'Sem dados do usu√°rio'
                    });
                    
                    // Habilitar bot√µes
                    document.getElementById('fetchUsersBtn').disabled = false;
                    document.getElementById('createWithoutBtn').disabled = false;
                    document.getElementById('createWithBtn').disabled = false;
                    
                    document.getElementById('loginResult').innerHTML = '<div class="success">‚úÖ Login realizado com sucesso!</div>';
                    return true;
                } else {
                    const errorData = await response.json();
                    updateStatus('tokenStatus', '‚ùå Erro no login', false);
                    logRequest('‚ùå Erro no login', { status: response.status, error: errorData });
                    document.getElementById('loginResult').innerHTML = `<div class="error">‚ùå Erro: ${errorData.detail || 'Login falhou'}</div>`;
                    return false;
                }
            } catch (error) {
                updateStatus('tokenStatus', '‚ùå Erro de conex√£o', false);
                logRequest('‚ùå Erro de conex√£o no login', { error: error.message });
                document.getElementById('loginResult').innerHTML = `<div class="error">‚ùå Erro de conex√£o: ${error.message}</div>`;
                return false;
            }
        }
        
        async function fetchUsers() {
            if (!authToken) {
                alert('Fa√ßa login primeiro!');
                return;
            }
            
            logRequest('üë• Buscando usu√°rios...');
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/users?limit=10`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    users = await response.json();
                    logRequest('‚úÖ Usu√°rios obtidos', { count: users.length });
                    
                    // Preencher select
                    const select = document.getElementById('responsavelSelect');
                    select.innerHTML = '<option value="">Selecione um usu√°rio...</option>';
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = `${user.nome} (ID: ${user.id})`;
                        select.appendChild(option);
                    });
                    
                    document.getElementById('usersResult').innerHTML = `<div class="success">‚úÖ ${users.length} usu√°rios encontrados</div>`;
                } else {
                    const errorData = await response.json();
                    logRequest('‚ùå Erro ao buscar usu√°rios', { status: response.status, error: errorData });
                    document.getElementById('usersResult').innerHTML = `<div class="error">‚ùå Erro: ${errorData.detail || 'Falha ao buscar usu√°rios'}</div>`;
                }
            } catch (error) {
                logRequest('‚ùå Erro de conex√£o ao buscar usu√°rios', { error: error.message });
                document.getElementById('usersResult').innerHTML = `<div class="error">‚ùå Erro de conex√£o: ${error.message}</div>`;
            }
        }
        
        async function testCreateWithoutResponsavel() {
            if (!authToken) {
                alert('Fa√ßa login primeiro!');
                return;
            }
            
            const codigoMaster = document.getElementById('codigoMaster1').value;
            
            const itemData = {
                unidade: "ULOG",
                codigo_master: codigoMaster,
                descritivo_resumido: "Item de teste SEM respons√°vel t√©cnico"
            };
            
            logRequest('üìù Criando item SEM respons√°vel t√©cnico...', itemData);
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/catalogo`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(itemData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    logRequest('‚úÖ Item criado SEM respons√°vel', result);
                    document.getElementById('createWithoutResult').innerHTML = `<div class="success">‚úÖ Item criado! ID: ${result.id}</div>`;
                } else {
                    const errorData = await response.json();
                    logRequest('‚ùå Erro ao criar item SEM respons√°vel', { status: response.status, error: errorData });
                    document.getElementById('createWithoutResult').innerHTML = `<div class="error">‚ùå Erro: ${errorData.detail || 'Falha ao criar item'}</div>`;
                }
            } catch (error) {
                logRequest('‚ùå Erro de conex√£o ao criar item SEM respons√°vel', { error: error.message });
                document.getElementById('createWithoutResult').innerHTML = `<div class="error">‚ùå Erro de conex√£o: ${error.message}</div>`;
            }
        }
        
        async function testCreateWithResponsavel() {
            if (!authToken) {
                alert('Fa√ßa login primeiro!');
                return;
            }
            
            const codigoMaster = document.getElementById('codigoMaster2').value;
            const responsavelId = document.getElementById('responsavelSelect').value;
            
            if (!responsavelId) {
                alert('Selecione um respons√°vel t√©cnico!');
                return;
            }
            
            const itemData = {
                unidade: "ULOG",
                codigo_master: codigoMaster,
                descritivo_resumido: "Item de teste COM respons√°vel t√©cnico",
                responsavel_tecnico_id: parseInt(responsavelId)  // CAMPO QUE CAUSA PROBLEMA
            };
            
            logRequest('üìù Criando item COM respons√°vel t√©cnico...', itemData);
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/catalogo`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(itemData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    logRequest('‚úÖ Item criado COM respons√°vel', result);
                    document.getElementById('createWithResult').innerHTML = `<div class="success">‚úÖ Item criado! ID: ${result.id}</div>`;
                } else {
                    const errorData = await response.json();
                    logRequest('‚ùå Erro ao criar item COM respons√°vel', { status: response.status, error: errorData });
                    document.getElementById('createWithResult').innerHTML = `<div class="error">‚ùå Erro: ${errorData.detail || 'Falha ao criar item'}</div>`;
                }
            } catch (error) {
                logRequest('‚ùå Erro de conex√£o ao criar item COM respons√°vel', { error: error.message });
                document.getElementById('createWithResult').innerHTML = `<div class="error">‚ùå Erro de conex√£o: ${error.message}</div>`;
            }
        }
        
        // Verificar backend ao carregar
        window.onload = async () => {
            await checkBackend();
        };
    </script>
</body>
</html>
